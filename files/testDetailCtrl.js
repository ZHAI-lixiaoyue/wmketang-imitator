angular.controllers.controller("testDetailCtrl",["$ionicModal","$state","$calculate","$scope","$timeout","$openResource","$ionicPopup","$request","$ionicHistory","$stateParams","$prompt","$ionicScrollDelegate","phoneUtils","stuCorrect","examService",function(e,i,n,s,o,t,a,r,c,d,l,p,u,x,f){s.sceneID=d.sceneID,s.hideAnswer=d.hideAnswer,s.isOpenEachLook=parseInt(d.isOpenEachLook),s.isLoaded=!0,s.slideOptions={loop:!1,effect:"swipe",speed:500,pagination:!1,shortSwipes:!0,shortSwipesRatio:.9},s.view=d.view,s.index=Number(d.index);var h=s.user.info.utype,g=s.user;s.answerName=3===h?s.user.childS.ktinfo.realName+"的答案":"我的答案";var w,m,I=[],y=[];"string"==typeof d.exerciseIds?(I.push(d.exerciseIds),y.push(d.aqids)):(I=d.exerciseIds,y=d.aqids),s.options=["A","B","C","D","E","F","G","H","I","J","K"],s.total=y.length,s.current=s.index+1,s.exercise=[];for(var D=0;D<s.total;D++)s.exercise.push({unload:!0,dataLoad:!1});function v(e){angular.stopVoices(),p.scrollTop(),E(e-1),E(e),E(e+1)}function S(e){var i;x.examDetail&&x.examDetail.topic.forEach((function(n){n.exercises.forEach((function(n){n.eid==s.exercise[e].id&&(i=n.exerNo)}))})),i||(i=s.exercise[e]&&s.exercise[e].exerNo||e+1),o((function(){s.title="第"+i+"题，共"+s.total+"题"}))}function A(e,i){var n=s.exercise[i];s.exercise[i].isLoaded=!1,r.jsonp("wrong/detail",{wrongID:e},(function(e){n.isLoaded=!0,n.hasAnalysis=!1,e.data.analysis.options.forEach((function(e){e.checked&&(n.hasAnalysis=!0)})),n.hasTag=!1,e.data.detail.tag.forEach((function(e){e.id&&(n.hasTag=!0)})),n.tag=e.data.detail.tag,n.exerUnDone=!1,e.data.reviewedExercise.forEach((function(e){e.aqid||(s.exercise[i].exerUnDone=!0)})),n.reviewedExercise=e.data.reviewedExercise,s.exercise[i]=angular.extend(e.data,n)})),3===h&&r.jsonp("exercise/getRecommendWeike",{exerciseID:n.id,_host:appConf.IAS_HOST},(function(e){s.exercise[i].tagRecommendWeike=e.data}))}function E(e){if(s.exercise[e]&&s.exercise[e].isLoaded)s.index==e&&S(e);else if(y[e]||I[e]){var i=y[e]?{type:!0,id:y[e]}:{type:!1,id:I[e]};i.examID=d.examID,x.getExerciseDetail(i,(function(i){i.data?(s.exercise[e]=i.data,s.exercise[e].currentIndex=e==d.index?d.itemIndex:0,s.exercise[e].myAnswer=[],s.exercise[e].rightAnswer=[],s.exercise[e].myScore={},i.data.wrongID?A(i.data.wrongID,e):i.data.isLoaded=!0,angular.forEach(s.exercise[e].item,(function(i,n){var o="",t="",a=!1;if(s.exercise[e].myAnswer.push([]),s.exercise[e].rightAnswer.push([]),1==i.type||6==i.type||7==i.type||8==i.type||9==i.type){for(var r=0;r<i.options.length;r++){if(i.myOptions)for(var c=0;c<i.myOptions.length;c++)i.options[r].id==i.myOptions[c]&&(s.exercise[e].myAnswer[n].push(s.options[r]),t+=s.options[r]);"1"==i.options[r].right&&(o+=s.options[r],s.exercise[e].rightAnswer[n].push(s.options[r]))}s.exercise[e].item[n].isRight=o==t}else i.question[0]&&i.question[0].myAnswer&&/^\<img[\w\W]*\>$/.test(i.question[0].myAnswer)&&(a=!0),angular.forEach(i.question,(function(e,n){if(n&&(e.myAnswer||0===e.myAnswer)&&(a=!1),e.points&&0!=e.points.length)for(var s=0;s<e.points.length;s++)i.question[n].points[s].selected=1==i.question[n].points[s].selected;else i.noPoints=!0})),i.isIAS=a})),s.index==e&&S(e)):s.dataNone=!0}),(function(i){s.exercise[e].dataLoad=!1,s.dataError=!0,l.showTip(i.msg)}))}}function T(e,i){e.answerExerciseID&&r.jsonp("exam/getItemLikeUserName",{_host:appConf.DS2_HOST,aexid:e.answerExerciseID},(function(n){e.nameList=n.data,e.likeNum=n.data.length,l.loading.hide(),i&&i()}),(function(e){l.showTip(e.msg),l.loading.hide()}))}s.startSlide=function(){s.slider.unlockSwipes()},s.stopSlide=function(){s.slider.lockSwipes()},s.$on("$ionicSlides.sliderInitialized",(function(e,i){i.slider.slideTo(s.index,0),s.slider=i.slider})),s.$on("$ionicView.beforeEnter",(function(e,i){s.exercise[s.index]&&s.exercise[s.index].wrongID&&A(s.exercise[s.index].wrongID,s.index),w&&T(w,null)})),o((function(){m=!0}),500),s.$on("$ionicSlides.slideChangeStart",(function(e,i){s.index=i.slider.activeIndex,m&&v(i.slider.activeIndex)})),s.openWeiKe=function(e){l.loading.show(),r.jsonp("user/getUserCourseStat",{ssk:g.childS.ssk,_host:appConf.XT_HOST},(function(n){l.loading.hide(),n.data.buyStat.mingshiCourse?(s.isHideFavor=!0,e.type=26,e.itype="video",e.scope=s,t(e)):i.go("main.buyIntroduce365")}),(function(e){l.loading.hide(),console.log(e),l.showTip("打开失败,请重试")}))},v(s.index),s.$on("$ionicSlides.slideChangeEnd",(function(e,i){s.activeIndex=i.slider.activeIndex,s.previousIndex=i.slider.previousIndex})),s.selfAppraise=function(e,i,n){var o={_host:appConf.KT3_HOST,appraise:[[{aexid:i,score:0}]]};n&&(o.appraise[0][0].score+=parseFloat(n));var t=[];angular.forEach(s.exercise[s.index].item[e].question,(function(e){e.points&&(t=t.concat(e.points))})),angular.forEach(t,(function(e){e.selected&&(o.appraise[0][0].score+=parseInt(e.score))})),l.loading.show(),f.selfAppraise(o,(function(){l.loading.hide(),s.exercise[s.index].myScore[e]=o.appraise[0][0].score,l.showTip("自评分成功！"),s.exercise[s.index].item[e].self=o.appraise[0][0].score}),(function(e){l.loading.hide(),l.showTip(e.msg)}))},s.myPopupShow=function(e,i,o,t,a,r){if(5!=s.sceneID&&!r.tscore&&0!=r.tscore&&!r.sysScore&&0!=r.sysScore){if(!t&&0!=t)return l.showTip("该题目未设置分值，暂无法评分");s.selectScore={index:null,max:t,list:[]};for(var c=0;c<=parseInt(t);c++)s.selectScore.list.push(c);n.create({scope:s,max:t},(function(i){s.selfAppraise(e,a,i)}))}},s.getHelp=function(e){s.exercise[s.index].item[e].showHelp=!s.exercise[s.index].item[e].showHelp,p.resize()},s.openHelp=function(e,i){t({url:e,title:i,itype:"video",scope:s,animation:"slide-in-right"})},s.AnalysisOpacity=0,s.wrongAnalysis=function(e){s.isWrongAnalysis=e,s.AnalysisOpacity=e?1:0},s.submitWrongAnalysis=function(){var e="";if(angular.forEach(s.exercise[s.index].analysis.options,(function(i){i.checked&&(e+=i.id+",")})),!e)return l.showTip("请选择错因!");l.loading.show(),r.jsonp("wrong/review",{wrongID:s.exercise[s.index].wrongID,typeID:e,note:s.exercise[s.index].analysis.note},(function(){l.loading.hide(),l.showTip("提交成功"),s.wrongAnalysis(!1),s.exercise[s.index].reviewed=1,s.exercise[s.index].hasAnalysis=!0}),(function(e){l.loading.hide(),l.showTip(e.msg)}))},s.setReview=function(e){e&&e.preventDefault(),s.exercise[s.index].reviewed||(s.exercise[s.index].reviewed=1,r.jsonp("wrong/review",{flag:1,wrongID:d.wrongID},(function(){}),(function(e){l.showTip(e.msg)})))},s.sendFeeback=function(){s.hasFeedback=!0,l.showTip("感谢你的反馈"),r.jsonp("wrong/exerFeedback",{exerciseID:s.detail.detail.id,feedbackType:11})},s.toDo=function(n){!function(n){var o=[],t=s.exercise[n];angular.forEach(t.reviewedExercise,(function(e){e.aqid||o.push(e.id)})),s.hasTag=s.exercise[n].hasTag,o.length?i.go(3===h?"main.stuWQDo":"tab.stuWQDo",{ids:o,aeid:t.aeid,wrongID:t.wrongID}):e.fromTemplateUrl((3===h?"page":"pages")+"/wrongQuestion/addSimilarQuestions.html",{animation:"slide-in-right",scope:s}).then((function(e){s.similarQuestionsModal=e,e.show()}))}(n)},s.toDetail=function(e,n){var s={view:"wq",index:n,exerciseIds:[],aqids:[]};angular.forEach(e,(function(e){s.exerciseIds.push(e.id),s.aqids.push(e.aqid)})),i.go(3===h?"main.testDetail":"tab.stuTestDetail",s)},s.contentClick=function(){s.exercise.forEach((function(e){e.item&&e.item.forEach((function(e){e.showLikeName=!1}))}))},s.getLikeName=function(e,i){e.stopPropagation(),i.showLikeName?i.showLikeName=!i.showLikeName:(l.loading.show(),T(i,(function(){i.showLikeName=!0})))},s.goMateAnswer=function(e){var n={classID:d.classID,assignmentItemID:d.assignmentItemID,examID:d.examID,itemID:e.exerciseItemID,itemType:e.type,isIAS:e.isIAS};w=e,i.go("main.lookMateAnswer",n)}}]);