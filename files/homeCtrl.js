angular.controllers.controller("homeCtrl",["$rootScope","$state","$scope","$ionicTabsDelegate","$ionicHistory","user","requestTF","lokiService","prompt","$ionicScrollDelegate","localStorage","phoneUtils","$timeout","$ionicPopup","$ionicPlatform","activateAccount","scrollSelect","requestP","$class",function(e,t,o,i,n,s,a,u,r,c,l,d,h,f,S,g,p,T,m){var b=null,w=new Date(new Date((new Date).toLocaleDateString()).getTime()+864e5);o.tab=0,o.user=s.user,o.gradeData={},o.evaluationView={total:0,list:[]},o.wrongExam={total:0},o.examRecords={total:0},o.currentStatus={joinStat:0,buyStat:0,mingshi:0},o.items_list={list:[]},o.recordDetail={mySelf:0};var y,k=!0;function v(){var e=new Date,t=w.getTime()-e.getTime(),o=t%864e5,i=o%36e5,n=i%6e4;!function(e,t,o,i){if(24*e*60*60*1e3+24*t*60*60*1e3+60*o*60*1e3+60*i*1e3<=0){var n=JSON.parse(l.get("tipCourse"));n[s.user.childS.uid]={},l.set("tipCourse",n),window.clearInterval&&window.clearInterval(b)}}(Math.floor(t/864e5),Math.floor(o/36e5),Math.floor(i/6e4),Math.round(n/1e3))}o.$on("$ionicView.beforeEnter",(function(){s.user.info.email||s.user.info.phone?!ionic.Platform.isWeiXin()&&s.user.info.isWeakPwd&&h((function(){y=r.confirm("登录密码与初始密码一致，存在盗号风险，建议您立即修改密码。",(function(){t.go("main.setPwd",{force:!0})}),"修改密码","退出",(function(){s.loginOut()}),!0)}),250):h((function(){var e=S.registerBackButtonAction((function(e){}),401),o=[{text:"绑定邮箱",type:"kt-box-pointBtn p0 button-balanced button-outline",onTap:function(){t.go("main.setEmailOrPhone",{type:2,force:!0}),e&&e()}},{text:"绑定手机",type:"kt-box-pointBtn p0 button-balanced button-outline",onTap:function(){t.go("main.setEmailOrPhone",{type:1,force:!0}),e&&e()}},{text:"退出",type:"kt-box-pointBtn p0 button-balanced button-outline",onTap:function(){s.loginOut(),e&&e()}}];s.user.info.children&&s.user.info.children.length&&o.splice(2,0,{text:"解绑孩子",type:"kt-box-pointBtn p0 button-balanced button-outline",onTap:function(){t.go("main.setChild",{type:1,force:!0}),e&&e()}}),y=f.show({title:"为了您的账号安全，请先绑定手机号或邮箱。",cssClass:"popup-round-list",buttons:o})}),250)})),o.$on("$ionicView.beforeLeave",(function(){y&&y.close()})),!s.user.childS&&s.user.info.children&&(s.user.childS=s.user.info.children[0]),o.showGradeList=!1,o.toggleGradeList=function(e){o.showGradeList=!o.showGradeList,p.grade((function(e,t,i){console.log(o.user),console.log(e,t,i),o.user.childS.gradeName=e[1],o.user.childS.gradeID=t,o.user.childS.subSubjectID=i,o.user.childS.subSubject=e[1]+(e[2]||"")}),$(e.target),o)},o.showChildList=!1,o.toggleChildList=function(){o.showChildList=!o.showChildList},o.recordData={},o.selectChild=function(e){s.user.info.childIndex=e,s.user.childS=s.user.info.children[e],s.saveUser(),s.user.childS.ktinfo&&o.$broadcast("enter.home");var t=JSON.parse(l.get("tipCourse"));t[s.user.childS.uid]&&!t[s.user.childS.uid].endTime?o.isShowBox=!0:(t[s.user.childS.uid]={},o.isShowBox=!1),l.set("tipCourse",t),a.jsonp("syncEvaluation/getUserRecentPracticeStat",{ssk:s.user.childS.ssk},(function(e){o.wrongExam.total=e.data.wrongNum||0,o.examRecords.total=e.data.practiceNum||0}),(function(e){r.showTip(e.msg)})),a.jsonp("syncEvaluation/myPractices",{tabType:"cloudspace",start:0,len:10,ssk:s.user.childS.ssk},(function(e){o.evaluationView.total=e.data.total||0,o.evaluationView.list=e.data.list}),(function(e){r.showTip(e.msg)})),a.jsonp("user/getUserCourseStat",{ssk:s.user.childS.ssk},(function(e){o.currentStatus.joinStat=e.data.joinStat,o.currentStatus.buyStat=e.data.buyStat}),(function(e){$prompt.showTip(e.msg)})),a.jsonp("user/getTestRecordTotal",{ssk:s.user.childS.ssk},(function(e){e.data&&(u.userKeyValue.recordDetail={evaluationDoneTotal:e.data.evaluationDoneTotal||0,reviewDoneTotal:e.data.reviewDoneTotal||0,reviewTotal:e.data.reviewTotal||0},o.recordData.recordDetail=u.userKeyValue.recordDetail)}),(function(e){r.showTip(e.msg)})),a.jsonp("study/isTipBuyCourse",{uid:s.user.childS.uid||s.user.info.ktuid},(function(e){(console.log(e),1==e.data.status)?JSON.parse(l.get("tipCourse"))[s.user.childS.uid].endTime||(o.isShowBox=!0):o.isShowBox=!1}),(function(e){r.showTip(e.msg)})),a.jsonp("schedule/situation",{_host:appConf.XTP_HOST,uid:s.user.childS.uid||s.user.info.ktuid},(function(e){console.log(e),o.result=e}),(function(e){r.showTip(e.msg)})),a.jsonp("user/GetEnergyRankList",{limit:100,offset:0},(function(e){u.userKeyValue.mySelf=e.data.mySelf,o.mySelf=u.userKeyValue.mySelf,o.recordDetail.mySelf=u.userKeyValue.mySelf}),(function(e){r.showTip(e.msg)})),o.toggleChildList(),s.user.childS.ktinfo?(0==o.tab?k?(o.changeTypeTab(0),o.toggleTab(0)):window.setTimeout((function(){o.changeTypeTab(1),o.toggleTab(1)}),0):(s.user.childS.ktinfo.ssk||(r.loading.show(),T.jsonp("user/GetKtUserInfoBySSK",{ssk:s.user.childS.ssk},(function(e){e.data&&(s.user.childS.ktinfo=e.data,m.friends[s.user.childS.ktinfo.uid]=e.data,s.user.childS.ktInfoLoaded=!0,s.saveUser()),r.loading.hide()}),(function(e){r.showTip(e.msg),r.loading.hide()}),{retryCount:4,retryInterval:3e3})),a.jsonp("user/recommendCourses",{_host:appConf.T_HOST,ssk:s.user.childS.ssk},(function(e){o.items_list.list=e.data.list||[]}),(function(e){r.showTip(e.msg)})),o.changeTypeTab(1),o.toggleTab(1)),k=!0):0!=o.tab&&1!=o.tab||(k=!1,o.changeTypeTab(1),o.toggleTab(0)),console.log("$scope.tab",o.tab)},o.isLoaded=!0,o.$on("$ionicView.beforeLeave",(function(){document.querySelector("#audio")&&document.querySelector("#audio").load()})),o.toggleTab=function(e){o.tab=e,i.select(e)},o.$on("changeTab.home",(function(e,t){console.log("changeTab.home"),o.tab=t.index,i.select(t.index),o.typeTab=t.subIndex})),o.$on("$ionicView.beforeEnter",(function(){if(o.toggleTab(o.tab),o.$broadcast("enter.home"),s.user.childS){var e={};l.get("tipCourse")?e=JSON.parse(l.get("tipCourse")):e[s.user.childS.uid]={},e[s.user.childS.uid]?e[s.user.childS.uid].isShowBox||Number(e[s.user.childS.uid].endTime)!=w.getTime()?(console.log("不存在-1"),o.isShowBox=!0):(console.log("存在"),s.user.childS.isBuyCourse&&1==s.user.childS.isBuyCourse?(b&&window.clearInterval(b),o.isShowBox=!1,e[s.user.childS.uid]={}):(o.isShowBox=!1,b=window.setInterval((function(){v()}),1e3))):(console.log("不存在-2"),o.isShowBox=!0,e[s.user.childS.uid]={}),l.set("tipCourse",e),s.user.childS.ktinfo?0==s.currentTab?o.changeTypeTab(0):1==s.currentTab?o.changeTypeTab(1):o.changeTypeTab(0):o.changeTypeTab(1)}n.clearHistory(),setTimeout((function(){angular.hideSplashScreen()}),500)})),o.messageTab=0,o.changeMessageTab=function(e){o.messageTab=e},o.typeTab=0,o.changeTypeTab=function(e){o.typeTab=e,s.currentTab=e,1==e&&o.getData()},o.closeShowBox=function(){o.isShowBox=!1;var e=JSON.parse(l.get("tipCourse"));e[s.user.childS.uid]={isShowBox:!1,endTime:w.getTime().toString()},l.set("tipCourse",e),b=window.setInterval((function(){v()}),1e3)},o.getData=function(){var e=JSON.parse(l.get("tipCourse"));a.jsonp("user/getServiceStatus",{serviceID:35},(function(e){0==e.status?o.currentStatus.mingshi=e.data:r.showTip(e.msg)}),(function(e){r.showTip(e.msg)})),a.jsonp("user/getUserCourseStat",{ssk:s.user.childS.ssk},(function(e){o.currentStatus.joinStat=e.data.joinStat,o.currentStatus.buyStat=e.data.buyStat}),(function(e){o.dataError=!0})),a.jsonp("study/isTipBuyCourse",{uid:s.user.childS.uid||s.user.info.ktuid},(function(t){1==t.data.status?!e[s.user.childS.uid].isShowBox&&e[s.user.childS.uid].endTime?o.isShowBox=!1:o.isShowBox=!0:o.isShowBox=!1}),(function(e){r.showTip(e.msg)})),a.jsonp("schedule/situation",{_host:appConf.XTP_HOST,uid:s.user.childS.uid||s.user.info.ktuid},(function(e){o.result=e}),(function(e){r.showTip(e.msg)})),a.jsonp("user/GetEnergyRankList",{limit:100,offset:0},(function(e){u.userKeyValue.mySelf=e.data.mySelf,o.mySelf=u.userKeyValue.mySelf,o.recordDetail.mySelf=u.userKeyValue.mySelf}),(function(e){r.showTip(e.msg)}))},o.setChildInfo=function(){0==s.user.childS.ktinfo.activeStatus?g.showActivate({info:s.user.childS,index:s.user.info.childIndex}):t.go("main.perfectChildStep1")},e.$on("home.selectTab",(function(e,t){o.toggleTab(t.tab)}))}]);